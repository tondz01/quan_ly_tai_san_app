import 'dart:developer';

import 'package:flutter/material.dart';
import 'package:quan_ly_tai_san_app/routes/app_route_path.dart';
import 'package:quan_ly_tai_san_app/screen/login/auth/account_helper.dart';
import 'package:se_gay_components/core/utils/sg_log.dart';
import 'package:se_gay_components/main_wrapper/sg_sidebar_horizontal.dart';

/// Class ƒë·∫°i di·ªán cho m·ªôt m·ª•c trong menu
class MenuItem {
  // Bi·∫øn static ƒë·ªÉ ƒë·∫øm v√† t·∫°o ID t·ª± ƒë·ªông
  static int _nextIndex = 0;
  final String label;
  final IconData? icon;
  final Widget? child;
  final int index;
  final List<SubMenuItem> reportSubItems;
  final List<SubMenuGroup> projectGroups;
  final String route;

  // Constructor v·ªõi tham s·ªë index t√πy ch·ªçn
  const MenuItem._internal({
    required this.label,
    required this.index,
    this.child,
    this.icon,
    this.reportSubItems = const [],
    this.projectGroups = const [],
    this.route = '',
  });

  // Factory constructor t·ª± ƒë·ªông t·∫°o index
  factory MenuItem({
    required String label,
    IconData? icon,
    Widget? child,
    int? index,
    List<SubMenuItem> reportSubItems = const [],
    List<SubMenuGroup> projectGroups = const [],
    String route = '',
  }) {
    // N·∫øu index ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh, s·ª≠ d·ª•ng n√≥
    // N·∫øu kh√¥ng, d√πng gi√° tr·ªã ti·∫øp theo v√† tƒÉng bi·∫øn ƒë·∫øm
    final actualIndex = index ?? _nextIndex++;

    return MenuItem._internal(
      label: label,
      index: actualIndex,
      icon: icon,
      reportSubItems: reportSubItems,
      projectGroups: projectGroups,
      route: route,
      child: child,
    );
  }
}

/// Class ƒë·∫°i di·ªán cho m·ªôt m·ª•c con trong submenu
class SubMenuItem {
  final String label;
  final IconData? icon;
  final Widget? child;
  final String route;
  final String? extra;
  final Function(BuildContext context)? callback;
  const SubMenuItem({
    required this.label,
    this.icon,
    this.route = '',
    this.extra,
    this.child,
    this.callback,
  });
}

/// Class ƒë·∫°i di·ªán cho m·ªôt nh√≥m c√°c m·ª•c trong submenu
class SubMenuGroup {
  final String title;
  final List<SubMenuItem> items;

  const SubMenuGroup({required this.title, required this.items});
}

/// Notifier ƒë·ªÉ qu·∫£n l√Ω vi·ªác c·∫≠p nh·∫≠t count values
class MenuDataNotifier extends ChangeNotifier {
  static final MenuDataNotifier _instance = MenuDataNotifier._internal();
  factory MenuDataNotifier() => _instance;
  MenuDataNotifier._internal();

  /// Refresh t·∫•t c·∫£ count values v√† th√¥ng b√°o cho listeners
  void refreshCounts() {
    log('message refreshCounts MenuDataNotifier');
    notifyListeners();
  }
}

/// Class qu·∫£n l√Ω to√†n b·ªô d·ªØ li·ªáu menu
class AppMenuData extends ChangeNotifier {
  late final List<MenuItem> menuItems;
  final MenuDataNotifier _notifier = MenuDataNotifier();
  
  // üî• TH√äM: ValueNotifier ƒë·ªÉ trigger rebuild
  final ValueNotifier<int> _countTrigger = ValueNotifier<int>(0);
  
  // üî• TH√äM: Singleton instance
  static AppMenuData? _instance;
  static AppMenuData get instance {
    _instance ??= AppMenuData._internal();
    return _instance!;
  }

  AppMenuData._internal() {
    MenuItem._nextIndex = 0;
    _buildMenuItems();
    
    // L·∫Øng nghe thay ƒë·ªïi t·ª´ notifier
    _notifier.addListener(() {
      notifyListeners();
    });
  }

  void _buildMenuItems() {
    menuItems = [
      MenuItem(label: 'T·ªïng quan', route: AppRoute.dashboard.path),
      MenuItem(
        label: 'Danh m·ª•c',
        route: AppRoute.category.path,
        reportSubItems: [
          SubMenuItem(
            label: 'Qu·∫£n l√Ω nh√¢n vi√™n',
            route: AppRoute.staffManager.path,
          ),
          SubMenuItem(
            label: 'Qu·∫£n l√Ω ph√≤ng ban',
            route: AppRoute.departmentManager.path,
          ),
          SubMenuItem(label: 'Qu·∫£n l√Ω ch·ª©c v·ª•', route: AppRoute.role.path),
          SubMenuItem(
            label: 'Qu·∫£n l√Ω d·ª± √°n',
            route: AppRoute.projectManager.path,
          ),
          SubMenuItem(
            label: 'Qu·∫£n l√Ω ngu·ªìn v·ªën',
            route: AppRoute.capitalSource.path,
          ),
          SubMenuItem(
            label: 'M√¥ h√¨nh t√†i s·∫£n',
            route: AppRoute.assetCategory.path,
          ),
          SubMenuItem(label: 'Nh√≥m t√†i s·∫£n', route: AppRoute.assetGroup.path),
          SubMenuItem(label: 'Nh√≥m ccdc', route: AppRoute.ccdcGroup.path),
        ],
      ),
      MenuItem(label: 'Qu·∫£n l√Ω t√†i s·∫£n', route: AppRoute.assetManagement.path),
      MenuItem(
        label: 'Qu·∫£n l√Ω CCDC - V·∫≠t t∆∞',
        route: AppRoute.toolsAndSupplies.path,
      ),
      MenuItem(
        label: 'ƒêi·ªÅu ƒë·ªông t√†i s·∫£n ',
        child: _buildRealtimeCountWidget(() => 
          countAssetTransfer + countAssetTransfer2 + countAssetTransfer3
        ),
        reportSubItems: [
          SubMenuItem(
            label: 'C·∫•p ph√°t t√†i s·∫£n',
            child: _buildRealtimeCountWidget(() => countAssetTransfer),
            route: AppRoute.assetTransfer.path,
            extra: "1",
          ),
          SubMenuItem(
            label: 'ƒêi·ªÅu chuy·ªÉn t√†i s·∫£n',
            child: _buildRealtimeCountWidget(() => countAssetTransfer2),
            route: AppRoute.assetTransfer.path,
            extra: "3",
          ),
          SubMenuItem(
            label: 'Thu h·ªìi t√†i s·∫£n',
            child: _buildRealtimeCountWidget(() => countAssetTransfer3),
            route: AppRoute.assetTransfer.path,
            extra: "2",
          ),
        ],
      ),
      MenuItem(
        label: 'ƒêi·ªÅu ƒë·ªông CCDC - V·∫≠t t∆∞',
        child: _buildRealtimeCountWidget(() => 
          countToolAndSupplies + countToolAndSupplies2 + countToolAndSupplies3
        ),
        route: AppRoute.toolAndMaterialTransfer.path,
        reportSubItems: [
          SubMenuItem(
            label: 'C·∫•p ph√°t CCDC - v·∫≠t t∆∞',
            child: _buildRealtimeCountWidget(() => countToolAndSupplies),
            route: AppRoute.toolAndMaterialTransfer.path,
            extra: "1",
          ),
          SubMenuItem(
            label: 'ƒêi·ªÅu chuy·ªÉn CCDC - v·∫≠t t∆∞',
            child: _buildRealtimeCountWidget(() => countToolAndSupplies2),
            route: AppRoute.toolAndMaterialTransfer.path,
            extra: "3",
          ),
          SubMenuItem(
            label: 'Thu h·ªìi CCDC - v·∫≠t t∆∞',
            child: _buildRealtimeCountWidget(() => countToolAndSupplies3),
            route: AppRoute.toolAndMaterialTransfer.path,
            extra: "2",
          ),
        ],
      ),
      MenuItem(
        label: 'B√†n giao t√†i s·∫£n',
        child: _buildRealtimeCountWidget(() => countAssetHandover),
        route: AppRoute.assetHandover.path,
      ),
      MenuItem(
        label: 'B√†n giao CCDC-V·∫≠t t∆∞',
        child: _buildRealtimeCountWidget(() => countToolAndMaterialHandover),
        route: AppRoute.toolAndSuppliesHandover.path,
      ),
      MenuItem(
        label: 'B√°o c√°o',
        reportSubItems: [
          SubMenuItem(
            label: "B√°o c√°o C·∫•p ph√°t t√†i s·∫£n trong k·ª≥",
            route: AppRoute.allocationReport.path,
          ),
          SubMenuItem(
            label: "B√°o c√°o ƒêi·ªÅu chuy·ªÉn t√†i s·∫£n trong k·ª≥",
            route: AppRoute.transferReport.path,
          ),
          SubMenuItem(
            label: "B√°o c√°o Thu h·ªìi t√†i s·∫£n trong k·ª≥",
            route: AppRoute.recoveryReport.path,
          ),
          SubMenuItem(
            label: 'Bi√™n b·∫£n ki·ªÉm k√™',
            route: AppRoute.bienBanKiemKe.path,
          ),
          SubMenuItem(
            label: 'Bi√™n b·∫£n ki·ªÉm k√™ CCDC',
            route: AppRoute.bienBanKiemKeCcdc.path,
          ),
        ],
      ),
    ];
  }

  // Getter methods ƒë·ªÉ l·∫•y count values
  int get countAssetTransfer => AccountHelper.instance.getAssetTransferCount(1);
  int get countAssetTransfer2 =>
      AccountHelper.instance.getAssetTransferCount(2);
  int get countAssetTransfer3 =>
      AccountHelper.instance.getAssetTransferCount(3);
  int get countToolAndSupplies =>
      AccountHelper.instance.getToolAndMaterialTransferCount(1);
  int get countToolAndSupplies2 =>
      AccountHelper.instance.getToolAndMaterialTransferCount(2);
  int get countToolAndSupplies3 =>
      AccountHelper.instance.getToolAndMaterialTransferCount(3);
  int get countAssetHandover => AccountHelper.instance.getAssetHandoverCount();
  int get countToolAndMaterialHandover =>
      AccountHelper.instance.getToolAndMaterialHandoverCount();

  /// Method ƒë·ªÉ refresh counts v√† rebuild menu items
  void refreshCounts() {
    // üî• TH√äM: Trigger rebuild
    _countTrigger.value++;
    notifyListeners();
  }

  /// Static method ƒë·ªÉ refresh counts t·ª´ b·∫•t k·ª≥ ƒë√¢u
  static void refreshAllCounts() {
    instance.refreshCounts();
  }

  // üî• TH√äM: Widget real-time v·ªõi ValueListenableBuilder
  Widget _buildRealtimeCountWidget(int Function() countGetter) {
    return ValueListenableBuilder<int>(
      valueListenable: _countTrigger,
      builder: (context, value, child) {
        final count = countGetter();
        return _buildShowCount(count);
      },
    );
  }

  // Chuy·ªÉn ƒë·ªïi SubMenuItem th√†nh SGSidebarSubItem
  SGSidebarSubItem convertToSGSubItem(
    SubMenuItem item,
    int parentIndex,
    int subIndex,
    bool isActive,
    VoidCallback onTap,
  ) {
    return SGSidebarSubItem(
      label: item.label,
      icon: item.icon,
      isActive: isActive,
      onTap: onTap,
      child: item.child,
    );
  }

  // Chuy·ªÉn ƒë·ªïi SubMenuGroup th√†nh SGSubItemGroup
  SGSubItemGroup convertToSGSubItemGroup(
    SubMenuGroup group,
    int parentIndex,
    int groupIndex,
    int selectedIndex,
    int selectedSubIndex,
    Function(int, int) onTapCallback,
  ) {
    return SGSubItemGroup(
      title: group.title,
      items: List.generate(group.items.length, (itemIndex) {
        final subIndex = groupIndex * 100 + itemIndex; // T·∫°o subIndex duy nh·∫•t
        return SGSidebarSubItem(
          label: group.items[itemIndex].label,
          icon: group.items[itemIndex].icon,
          isActive:
              selectedIndex == parentIndex && selectedSubIndex == subIndex,
          onTap: () => onTapCallback(parentIndex, subIndex),
          child: group.items[itemIndex].child,
        );
      }),
    );
  }

  Widget _buildShowCount(int count) {
    // Ch·ªâ hi·ªÉn th·ªã badge n·∫øu count > 0
    SGLog.debug('Home', 'Count: $count');
    log('message count: $count');
    if (count <= 0) return const SizedBox.shrink();

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        color: Colors.red,
        borderRadius: BorderRadius.circular(10),
      ),
      constraints: const BoxConstraints(minWidth: 18, minHeight: 18),
      child: Center(
        child: Text(
          count > 99 ? '99+' : '$count',
          style: const TextStyle(
            fontSize: 11,
            color: Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _countTrigger.dispose();
    _notifier.removeListener(() {});
    super.dispose();
  }
}
